<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‹ï¸ Diet Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; font-size: 1.8em; }
        .subtitle { text-align: center; color: #888; margin-bottom: 30px; font-size: 0.9em; }
        .hidden { display: none; }
        .error-box {
            background: rgba(239,68,68,0.2);
            border: 1px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .error-box h3 { color: #ef4444; margin-bottom: 10px; }
        .last-update { text-align: center; color: #666; font-size: 0.8em; margin-bottom: 20px; }
        .cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 700px) { .cards { grid-template-columns: 1fr; } }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card h2 { font-size: 1.4em; }
        .card.d h2 { color: #4facfe; }
        .card.m h2 { color: #f093fb; }
        .streak {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: rgba(251,146,60,0.2);
            border-radius: 20px;
            font-size: 0.9em;
        }
        .streak .fire { font-size: 1.1em; }
        .streak .count { font-weight: bold; color: #fb923c; }
        .stat {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stat:last-child { border-bottom: none; }
        .stat-label { color: #aaa; }
        .stat-value { font-weight: bold; font-size: 1.1em; }
        .stat-value.positive { color: #4ade80; }
        .stat-value.negative { color: #f87171; }
        .stat-value.weekly { color: #fbbf24; font-size: 0.9em; }
        .progress-container { margin: 20px 0; }
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #aaa;
        }
        .progress-bar {
            height: 28px;
            background: rgba(255,255,255,0.1);
            border-radius: 14px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            transition: width 0.5s;
            min-width: 40px;
        }
        .progress-fill.d { background: linear-gradient(90deg, #4facfe, #00f2fe); }
        .progress-fill.m { background: linear-gradient(90deg, #f093fb, #f5576c); }
        .eta-box {
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
        }
        .eta-box .label { color: #888; font-size: 0.85em; }
        .eta-box .value { font-size: 1.3em; font-weight: bold; margin-top: 5px; }
        .compliance {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        .compliance-item {
            text-align: center;
            padding: 10px 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        .compliance-item .label { font-size: 0.7em; color: #888; margin-bottom: 5px; }
        .compliance-item .value { font-size: 1.2em; font-weight: bold; }
        .compliance-item .value.green { color: #4ade80; }
        .compliance-item .value.yellow { color: #fbbf24; }
        .compliance-item .value.red { color: #f87171; }
        .personal-bests {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .pb-item {
            padding: 10px;
            background: rgba(74,222,128,0.1);
            border-radius: 10px;
            text-align: center;
        }
        .pb-item .label { font-size: 0.7em; color: #888; margin-bottom: 3px; }
        .pb-item .value { font-size: 1.1em; font-weight: bold; color: #4ade80; }
        .pb-item .date { font-size: 0.65em; color: #666; margin-top: 2px; }
        .badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            background: rgba(255,255,255,0.08);
        }
        .badge.gold { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .badge.silver { background: rgba(156,163,175,0.2); color: #9ca3af; }
        .badge.bronze { background: rgba(217,119,6,0.2); color: #d97706; }
        .badge.special { background: rgba(168,85,247,0.2); color: #a855f7; }
        .section-box {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section-box h3 { color: #ccc; margin-bottom: 15px; }
        .milestones {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .milestone {
            padding: 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            text-align: center;
        }
        .milestone.achieved {
            background: rgba(74,222,128,0.15);
            border: 1px solid rgba(74,222,128,0.3);
        }
        .milestone .icon { font-size: 2em; margin-bottom: 8px; }
        .milestone .title { font-size: 0.9em; color: #aaa; margin-bottom: 5px; }
        .milestone .status { font-weight: bold; font-size: 1.1em; }
        .milestone.achieved .status { color: #4ade80; }
        .milestone:not(.achieved) .status { color: #666; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .data-table th {
            color: #888;
            font-weight: normal;
            font-size: 0.8em;
            text-transform: uppercase;
        }
        .data-table td { color: #ddd; }
        .data-table .positive { color: #4ade80; }
        .data-table .negative { color: #f87171; }
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab {
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-size: 0.85em;
        }
        .tab.active { background: rgba(79,172,254,0.2); color: #4facfe; }
        .tab:hover { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‹ï¸ Diet Tracker Pro</h1>
        <p class="subtitle">D & M â€” Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚ 2026</p>
        <p class="last-update" id="lastUpdate">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: â€”</p>

        <div class="error-box hidden" id="errorBox"><h3>âš ï¸ Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚</h3><p id="errorMsg"></p></div>

        <!-- Main Cards -->
        <div class="cards">
            <div class="card d" id="cardD">
                <div class="card-header"><h2>D</h2><div class="streak"><span class="fire">ğŸ”¥</span><span class="count" id="d-streak">0</span><span>Î·Î¼Î­ÏÎµÏ‚</span></div></div>
                <div class="stat"><span class="stat-label">Î‘ÏÏ‡Î¹ÎºÏŒ</span><span class="stat-value" id="d-start">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¤ÏÎ­Ï‡Î¿Î½</span><span class="stat-value" id="d-current">â€”</span></div>
                <div class="stat"><span class="stat-label">Î•Î²Î´Î¿Î¼. Î¼.Î¿.</span><span class="stat-value weekly" id="d-weekavg">â€”</span></div>
                <div class="stat"><span class="stat-label">Î‘Ï€ÏÎ»ÎµÎ¹Î±</span><span class="stat-value positive" id="d-lost">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¥Ï€Î¿Î»ÎµÎ¯Ï€ÎµÏ„Î±Î¹</span><span class="stat-value" id="d-remaining">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¡Ï…Î¸Î¼ÏŒÏ‚/ÎµÎ²Î´</span><span class="stat-value" id="d-rate">â€”</span></div>
                <div class="progress-container">
                    <div class="progress-label"><span>Î ÏÏŒÎ¿Î´Î¿Ï‚</span><span id="d-pct">0%</span></div>
                    <div class="progress-bar"><div class="progress-fill d" id="d-bar" style="width:5%"></div></div>
                </div>
                <div class="eta-box"><div class="label">ETA ÏƒÏ„ÏŒÏ‡Î¿Ï…</div><div class="value" id="d-eta">â€”</div></div>
                <div class="compliance">
                    <div class="compliance-item"><div class="label">Î”Î™Î‘Î™Î¤Î‘</div><div class="value" id="d-diet">â€”</div></div>
                    <div class="compliance-item"><div class="label">Î‘Î£ÎšÎ—Î£Î—</div><div class="value" id="d-gym">â€”</div></div>
                    <div class="compliance-item"><div class="label">8K+</div><div class="value" id="d-steps">â€”</div></div>
                    <div class="compliance-item"><div class="label">NO ALC</div><div class="value" id="d-alcohol">â€”</div></div>
                </div>
                <div class="personal-bests">
                    <div class="pb-item"><div class="label">ğŸ† ÎšÎ±Î»ÏÏ„ÎµÏÎ· ÎµÎ²Î´.</div><div class="value" id="d-bestweek">â€”</div><div class="date" id="d-bestweek-date"></div></div>
                    <div class="pb-item"><div class="label">ğŸ“… Max streak</div><div class="value" id="d-maxstreak">â€”</div></div>
                </div>
                <div class="badges" id="d-badges"></div>
            </div>

            <div class="card m" id="cardM">
                <div class="card-header"><h2>M</h2><div class="streak"><span class="fire">ğŸ”¥</span><span class="count" id="m-streak">0</span><span>Î·Î¼Î­ÏÎµÏ‚</span></div></div>
                <div class="stat"><span class="stat-label">Î‘ÏÏ‡Î¹ÎºÏŒ</span><span class="stat-value" id="m-start">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¤ÏÎ­Ï‡Î¿Î½</span><span class="stat-value" id="m-current">â€”</span></div>
                <div class="stat"><span class="stat-label">Î•Î²Î´Î¿Î¼. Î¼.Î¿.</span><span class="stat-value weekly" id="m-weekavg">â€”</span></div>
                <div class="stat"><span class="stat-label">Î‘Ï€ÏÎ»ÎµÎ¹Î±</span><span class="stat-value positive" id="m-lost">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¥Ï€Î¿Î»ÎµÎ¯Ï€ÎµÏ„Î±Î¹</span><span class="stat-value" id="m-remaining">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¡Ï…Î¸Î¼ÏŒÏ‚/ÎµÎ²Î´</span><span class="stat-value" id="m-rate">â€”</span></div>
                <div class="progress-container">
                    <div class="progress-label"><span>Î ÏÏŒÎ¿Î´Î¿Ï‚</span><span id="m-pct">0%</span></div>
                    <div class="progress-bar"><div class="progress-fill m" id="m-bar" style="width:5%"></div></div>
                </div>
                <div class="eta-box"><div class="label">ETA ÏƒÏ„ÏŒÏ‡Î¿Ï…</div><div class="value" id="m-eta">â€”</div></div>
                <div class="compliance">
                    <div class="compliance-item"><div class="label">Î”Î™Î‘Î™Î¤Î‘</div><div class="value" id="m-diet">â€”</div></div>
                    <div class="compliance-item"><div class="label">Î‘Î£ÎšÎ—Î£Î—</div><div class="value" id="m-gym">â€”</div></div>
                    <div class="compliance-item"><div class="label">8K+</div><div class="value" id="m-steps">â€”</div></div>
                    <div class="compliance-item"><div class="label">NO ALC</div><div class="value" id="m-alcohol">â€”</div></div>
                </div>
                <div class="personal-bests">
                    <div class="pb-item"><div class="label">ğŸ† ÎšÎ±Î»ÏÏ„ÎµÏÎ· ÎµÎ²Î´.</div><div class="value" id="m-bestweek">â€”</div><div class="date" id="m-bestweek-date"></div></div>
                    <div class="pb-item"><div class="label">ğŸ“… Max streak</div><div class="value" id="m-maxstreak">â€”</div></div>
                </div>
                <div class="badges" id="m-badges"></div>
            </div>
        </div>

        <!-- Milestones -->
        <div class="section-box">
            <h3>ğŸ¯ Milestones</h3>
            <div class="tabs">
                <button class="tab active" onclick="showMilestones('d')">D</button>
                <button class="tab" onclick="showMilestones('m')">M</button>
            </div>
            <div class="milestones" id="milestones-d"></div>
            <div class="milestones hidden" id="milestones-m"></div>
        </div>

        <!-- Chart -->
        <div class="section-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h3 style="margin: 0;">ğŸ“ˆ Trend & Moving Average</h3>
                <div style="display: flex; gap: 15px; font-size: 0.8em; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 10px; height: 10px; border-radius: 50%; background:#4facfe"></div><span>D</span></div>
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 10px; height: 10px; border-radius: 50%; background:#f093fb"></div><span>M</span></div>
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 20px; height: 2px; background:#4facfe; opacity:0.4"></div><span>7d avg</span></div>
                </div>
            </div>
            <canvas id="weightChart"></canvas>
        </div>

        <!-- Weekly Summary -->
        <div class="section-box">
            <h3>ğŸ“Š Weekly Summary</h3>
            <div class="tabs">
                <button class="tab active" onclick="showWeekly('d')">D</button>
                <button class="tab" onclick="showWeekly('m')">M</button>
            </div>
            <div id="weekly-d"><table class="data-table"><thead><tr><th>Î•Î²Î´Î¿Î¼Î¬Î´Î±</th><th>Î‘ÏÏ‡Î®</th><th>Î¤Î­Î»Î¿Ï‚</th><th>Î‘Î»Î»Î±Î³Î®</th></tr></thead><tbody id="weekly-table-d"></tbody></table></div>
            <div id="weekly-m" class="hidden"><table class="data-table"><thead><tr><th>Î•Î²Î´Î¿Î¼Î¬Î´Î±</th><th>Î‘ÏÏ‡Î®</th><th>Î¤Î­Î»Î¿Ï‚</th><th>Î‘Î»Î»Î±Î³Î®</th></tr></thead><tbody id="weekly-table-m"></tbody></table></div>
        </div>

        <!-- Monthly Summary -->
        <div class="section-box">
            <h3>ğŸ“… Monthly Summary</h3>
            <div class="tabs">
                <button class="tab active" onclick="showMonthly('d')">D</button>
                <button class="tab" onclick="showMonthly('m')">M</button>
            </div>
            <div id="monthly-d"><table class="data-table"><thead><tr><th>ÎœÎ®Î½Î±Ï‚</th><th>Î‘ÏÏ‡Î®</th><th>Î¤Î­Î»Î¿Ï‚</th><th>Î‘Î»Î»Î±Î³Î®</th><th>ÎœÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚</th></tr></thead><tbody id="monthly-table-d"></tbody></table></div>
            <div id="monthly-m" class="hidden"><table class="data-table"><thead><tr><th>ÎœÎ®Î½Î±Ï‚</th><th>Î‘ÏÏ‡Î®</th><th>Î¤Î­Î»Î¿Ï‚</th><th>Î‘Î»Î»Î±Î³Î®</th><th>ÎœÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚</th></tr></thead><tbody id="monthly-table-m"></tbody></table></div>
        </div>

        <!-- Measurements History -->
        <div class="section-box">
            <h3>ğŸ“‹ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ ÎœÎµÏ„ÏÎ®ÏƒÎµÏ‰Î½</h3>
            <div class="tabs">
                <button class="tab active" onclick="showHistory('d')">D</button>
                <button class="tab" onclick="showHistory('m')">M</button>
            </div>
            <div id="history-d"><table class="data-table"><thead><tr><th>Î—Î¼/Î½Î¯Î±</th><th>Î’Î¬ÏÎ¿Ï‚</th><th>Î‘Î»Î»Î±Î³Î®</th><th>Î‘Ï€ÏŒ Î±ÏÏ‡Î®</th></tr></thead><tbody id="history-table-d"></tbody></table></div>
            <div id="history-m" class="hidden"><table class="data-table"><thead><tr><th>Î—Î¼/Î½Î¯Î±</th><th>Î’Î¬ÏÎ¿Ï‚</th><th>Î‘Î»Î»Î±Î³Î®</th><th>Î‘Ï€ÏŒ Î±ÏÏ‡Î®</th></tr></thead><tbody id="history-table-m"></tbody></table></div>
        </div>

        <!-- Heatmap -->
        <div class="section-box">
            <h3>ğŸ“… Consistency Heatmap</h3>
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1; overflow-x: auto;"><h4 style="font-size: 0.9em; margin-bottom: 10px; color: #4facfe;">D</h4><div style="display: flex; gap: 3px;" id="heatmap-d"></div></div>
                <div style="flex: 1; overflow-x: auto;"><h4 style="font-size: 0.9em; margin-bottom: 10px; color: #f093fb;">M</h4><div style="display: flex; gap: 3px;" id="heatmap-m"></div></div>
            </div>
            <div style="display: flex; align-items: center; gap: 5px; margin-top: 10px; font-size: 0.7em; color: #666;">
                <span>0/4</span>
                <div style="width: 14px; height: 14px; border-radius: 3px; background: rgba(255,255,255,0.05);"></div>
                <div style="width: 14px; height: 14px; border-radius: 3px; background: rgba(74,222,128,0.25);"></div>
                <div style="width: 14px; height: 14px; border-radius: 3px; background: rgba(74,222,128,0.5);"></div>
                <div style="width: 14px; height: 14px; border-radius: 3px; background: rgba(74,222,128,0.75);"></div>
                <div style="width: 14px; height: 14px; border-radius: 3px; background: rgba(74,222,128,1);"></div>
                <span>4/4</span>
            </div>
        </div>

        <!-- Comparison -->
        <div class="section-box" id="comparisonBox">
            <h3>âš–ï¸ Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· D vs M</h3>
            <div id="comparison" style="display: flex; flex-direction: column; gap: 15px;"></div>
        </div>
    </div>

    <script>
        const URLS = {
            D: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTP6nt9UQ58axQ8HfJrfQsJvC4HfWWFfNT9hwMMpq8sOkoFHhIcW10Cia802-JAig/pub?gid=1271072340&single=true&output=csv',
            M: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQv_roHZk_3uRLEW7V8heM98gXtuNy6juaveJgqkI-yFPHpr8icFwy8_pkTDeCoSw/pub?gid=1070987484&single=true&output=csv'
        };

        let CONFIG = {
            D: { start: 127.4, target: 110 },
            M: { start: 65.3, target: 58 }
        };

        const SETTINGS_URL = null;
        let chart = null;
        let allData = { D: null, M: null };

        function showMilestones(p) {
            document.querySelectorAll('.section-box:nth-of-type(2) .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('milestones-d').classList.toggle('hidden', p !== 'd');
            document.getElementById('milestones-m').classList.toggle('hidden', p !== 'm');
        }

        function showWeekly(p) {
            document.querySelectorAll('.section-box:nth-of-type(4) .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('weekly-d').classList.toggle('hidden', p !== 'd');
            document.getElementById('weekly-m').classList.toggle('hidden', p !== 'm');
        }

        function showMonthly(p) {
            document.querySelectorAll('.section-box:nth-of-type(5) .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('monthly-d').classList.toggle('hidden', p !== 'd');
            document.getElementById('monthly-m').classList.toggle('hidden', p !== 'm');
        }

        function showHistory(p) {
            document.querySelectorAll('.section-box:nth-of-type(6) .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('history-d').classList.toggle('hidden', p !== 'd');
            document.getElementById('history-m').classList.toggle('hidden', p !== 'm');
        }

        async function loadAllData() {
            document.getElementById('lastUpdate').textContent = 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...';
            let errors = [];

            if (SETTINGS_URL) {
                try {
                    const resp = await fetch(SETTINGS_URL);
                    if (resp.ok) {
                        const csv = await resp.text();
                        csv.split('\n').slice(1).forEach(row => {
                            const [person, start, target] = row.split(',').map(c => c.trim());
                            if (person === 'D' || person === 'M') CONFIG[person] = { start: parseFloat(start), target: parseFloat(target) };
                        });
                    }
                } catch(e) { console.warn('Settings not loaded'); }
            }

            for (const p of ['D', 'M']) {
                try {
                    const resp = await fetch(URLS[p]);
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    const csv = await resp.text();
                    console.log(`[DEBUG] ${p} CSV first 500 chars:`, csv.substring(0, 500));
                    allData[p] = parseCSV(csv, CONFIG[p]);
                    console.log(`[DEBUG] ${p} parsed data:`, allData[p]);
                    updateCard(p.toLowerCase(), allData[p], CONFIG[p]);
                    updateMilestones(p.toLowerCase(), allData[p], CONFIG[p]);
                    updateHistory(p.toLowerCase(), allData[p], CONFIG[p]);
                    updateWeekly(p.toLowerCase(), allData[p]);
                    updateMonthly(p.toLowerCase(), allData[p]);
                } catch(e) {
                    console.error(p + ' error:', e);
                    errors.push(p + ': ' + e.message);
                }
            }

            if (errors.length > 0) {
                document.getElementById('errorBox').classList.remove('hidden');
                document.getElementById('errorMsg').textContent = errors.join(' | ');
            }

            updateChart();
            updateHeatmaps();
            updateComparison();
            document.getElementById('lastUpdate').textContent = 'Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: ' + new Date().toLocaleString('el-GR');
        }

        function parseCSV(csv, cfg) {
            const rows = csv.split('\n').map(r => r.split(',').map(c => c.trim()));
            const data = rows.slice(1).filter(r => r[0] && r[0].length > 0);

            const cols = { date: 0, day: 1, weight: 2, diet: 3, gym: 4, steps: 5, alcohol: 6 };

            const weights = [], labels = [], dailyCompliance = [];
            let startKg = cfg.start;

            data.forEach(row => {
                const w = parseFloat(row[cols.weight]);
                if (w > 0) {
                    if (weights.length === 0) startKg = w;
                    labels.push(row[0]);
                    weights.push(w);
                }
                let score = 0;
                if (row[cols.diet] === 'TRUE') score++;
                if (row[cols.gym] === 'TRUE') score++;
                if (row[cols.steps] === 'TRUE') score++;
                if (row[cols.alcohol] === 'TRUE') score++;
                dailyCompliance.push(score);
            });

            // X/total (Î±Ï€ÏŒ Ï„Î·Î½ Î±ÏÏ‡Î®) Î±Î½Ï„Î¯ Î³Î¹Î± X/7
            const calcTotalCompliance = (colIndex) => {
                const filled = data.filter(r => r[colIndex] === 'TRUE' || r[colIndex] === 'FALSE');
                const success = filled.filter(r => r[colIndex] === 'TRUE').length;
                return { count: success, total: filled.length };
            };

            const calcCompliance = (col) => {
                const filled = data.filter(r => r[col] === 'TRUE' || r[col] === 'FALSE');
                const yes = filled.filter(r => r[col] === 'TRUE').length;
                return filled.length > 0 ? Math.round(yes / filled.length * 100) : 0;
            };

            let streak = 0;
            for (let i = dailyCompliance.length - 1; i >= 0; i--) {
                if (dailyCompliance[i] >= 3) streak++;
                else break;
            }

            let maxStreak = 0, tempStreak = 0;
            dailyCompliance.forEach(s => {
                if (s >= 3) { tempStreak++; maxStreak = Math.max(maxStreak, tempStreak); }
                else tempStreak = 0;
            });

            let bestWeek = { loss: 0, date: '' };
            for (let i = 1; i < weights.length; i++) {
                const loss = weights[i-1] - weights[i];
                if (loss > bestWeek.loss) bestWeek = { loss, date: labels[i] };
            }

            const ma = weights.map((_, i) => {
                const slice = weights.slice(Math.max(0, i - 6), i + 1);
                return slice.reduce((a,b) => a+b, 0) / slice.length;
            });

            const last7 = weights.slice(-7);
            const weekAvg = last7.length > 0 ? last7.reduce((a,b) => a+b, 0) / last7.length : null;

            return {
                weights, labels, ma, dailyCompliance, startKg,
                current: weights.length > 0 ? weights[weights.length - 1] : null,
                weekAvg, streak, maxStreak, bestWeek,
                totalCompliance: {
                    diet: calcTotalCompliance(cols.diet),
                    gym: calcTotalCompliance(cols.gym),
                    steps: calcTotalCompliance(cols.steps),
                    alcohol: calcTotalCompliance(cols.alcohol)
                },
                compliance: {
                    diet: calcCompliance(cols.diet),
                    gym: calcCompliance(cols.gym),
                    steps: calcCompliance(cols.steps),
                    alcohol: calcCompliance(cols.alcohol)
                }
            };
        }

        function getComplianceColor(count, total) {
            if (total === 0) return 'red';
            const pct = count / total * 100;
            if (pct >= 80) return 'green';
            if (pct >= 50) return 'yellow';
            return 'red';
        }

        function updateCard(p, data, cfg) {
            if (!data || !data.startKg) return;
            const start = data.startKg, current = data.current || start, target = cfg.target;
            const lost = start - current, remaining = current - target;
            const weeks = Math.max(1, data.weights.length - 1), rate = lost / weeks;
            const pct = Math.min(100, Math.max(0, lost / (start - target) * 100));
            const etaWeeks = rate > 0 ? Math.ceil(remaining / rate) : null;

            document.getElementById(`${p}-start`).textContent = start.toFixed(1) + ' kg';
            document.getElementById(`${p}-current`).textContent = current.toFixed(1) + ' kg';
            document.getElementById(`${p}-weekavg`).textContent = data.weekAvg ? data.weekAvg.toFixed(1) + ' kg' : 'â€”';

            const lostEl = document.getElementById(`${p}-lost`);
            lostEl.textContent = (lost >= 0 ? '-' : '+') + Math.abs(lost).toFixed(1) + ' kg';
            lostEl.className = 'stat-value ' + (lost >= 0 ? 'positive' : 'negative');

            document.getElementById(`${p}-remaining`).textContent = remaining.toFixed(1) + ' kg';
            document.getElementById(`${p}-rate`).textContent = rate.toFixed(2) + ' kg';
            document.getElementById(`${p}-pct`).textContent = pct.toFixed(0) + '%';
            document.getElementById(`${p}-bar`).style.width = Math.max(5, pct) + '%';
            document.getElementById(`${p}-bar`).textContent = pct.toFixed(0) + '%';
            document.getElementById(`${p}-eta`).textContent = etaWeeks ? `~${etaWeeks} ÎµÎ²Î´.` : 'â€”';
            document.getElementById(`${p}-streak`).textContent = data.streak;

            const tc = data.totalCompliance;
            
            const dietEl = document.getElementById(`${p}-diet`);
            dietEl.textContent = `${tc.diet.count}/${tc.diet.total}`;
            dietEl.className = 'value ' + getComplianceColor(tc.diet.count, tc.diet.total);

            const gymEl = document.getElementById(`${p}-gym`);
            gymEl.textContent = `${tc.gym.count}/${tc.gym.total}`;
            gymEl.className = 'value ' + getComplianceColor(tc.gym.count, tc.gym.total);

            const stepsEl = document.getElementById(`${p}-steps`);
            stepsEl.textContent = `${tc.steps.count}/${tc.steps.total}`;
            stepsEl.className = 'value ' + getComplianceColor(tc.steps.count, tc.steps.total);

            const alcoholEl = document.getElementById(`${p}-alcohol`);
            alcoholEl.textContent = `${tc.alcohol.count}/${tc.alcohol.total}`;
            alcoholEl.className = 'value ' + getComplianceColor(tc.alcohol.count, tc.alcohol.total);

            document.getElementById(`${p}-bestweek`).textContent = data.bestWeek.loss > 0 ? '-' + data.bestWeek.loss.toFixed(1) + ' kg' : 'â€”';
            document.getElementById(`${p}-bestweek-date`).textContent = data.bestWeek.date;
            document.getElementById(`${p}-maxstreak`).textContent = data.maxStreak + ' Î·Î¼Î­ÏÎµÏ‚';

            const badges = [];
            if (lost >= 1) badges.push({ text: 'ğŸ¯ First kg', class: 'bronze' });
            if (lost >= 5) badges.push({ text: 'ğŸ¥‡ 5kg Club', class: 'gold' });
            if (lost >= 10) badges.push({ text: 'ğŸ† 10kg Club', class: 'gold' });
            if (data.maxStreak >= 7) badges.push({ text: 'ğŸ”¥ 7-day streak', class: 'bronze' });
            if (data.maxStreak >= 14) badges.push({ text: 'âš¡ 14-day streak', class: 'special' });
            if (data.compliance.diet >= 90) badges.push({ text: 'ğŸ’ª Diet Master', class: 'special' });
            if (data.weights.length >= 7) badges.push({ text: 'ğŸ“… Week 1', class: 'silver' });
            if (data.weights.length >= 30) badges.push({ text: 'ğŸ“… Month 1', class: 'silver' });
            document.getElementById(`${p}-badges`).innerHTML = badges.map(b => `<span class="badge ${b.class}">${b.text}</span>`).join('');
        }

        function updateMilestones(p, data, cfg) {
            if (!data) return;
            const lost = data.startKg - (data.current || data.startKg);
            const totalToLose = data.startKg - cfg.target;
            const halfway = totalToLose / 2;
            const milestones = [
                { icon: 'ğŸ¯', title: 'Î ÏÏÏ„Î¿ ÎºÎ¹Î»ÏŒ', target: 1, achieved: lost >= 1 },
                { icon: 'â­', title: '5 ÎºÎ¹Î»Î¬', target: 5, achieved: lost >= 5 },
                { icon: 'ğŸ†', title: '10 ÎºÎ¹Î»Î¬', target: 10, achieved: lost >= 10 },
                { icon: 'ğŸ‰', title: 'ÎœÎ¹ÏƒÏŒÏ‚ Î´ÏÏŒÎ¼Î¿Ï‚', target: halfway, achieved: lost >= halfway },
                { icon: 'ğŸ‘‘', title: 'Î£Ï„ÏŒÏ‡Î¿Ï‚!', target: totalToLose, achieved: lost >= totalToLose }
            ];
            document.getElementById(`milestones-${p}`).innerHTML = milestones.map(m => `
                <div class="milestone ${m.achieved ? 'achieved' : ''}">
                    <div class="icon">${m.icon}</div>
                    <div class="title">${m.title} (${m.target.toFixed(1)} kg)</div>
                    <div class="status">${m.achieved ? 'âœ“ Î•Ï€Î¹Ï„ÎµÏÏ‡Î¸Î·ÎºÎµ!' : `${Math.min(100, lost/m.target*100).toFixed(0)}%`}</div>
                </div>
            `).join('');
        }

        function updateHistory(p, data, cfg) {
            if (!data || data.weights.length === 0) return;
            const rows = [];
            for (let i = data.weights.length - 1; i >= 0 && rows.length < 20; i--) {
                const w = data.weights[i];
                const prev = i > 0 ? data.weights[i-1] : w;
                const change = w - prev;
                const fromStart = w - data.startKg;
                rows.push(`<tr>
                    <td>${data.labels[i]}</td>
                    <td>${w.toFixed(1)} kg</td>
                    <td class="${change <= 0 ? 'positive' : 'negative'}">${change === 0 ? 'â€”' : (change > 0 ? '+' : '') + change.toFixed(1)}</td>
                    <td class="${fromStart <= 0 ? 'positive' : 'negative'}">${fromStart > 0 ? '+' : ''}${fromStart.toFixed(1)}</td>
                </tr>`);
            }
            document.getElementById(`history-table-${p}`).innerHTML = rows.join('');
        }

        function updateWeekly(p, data) {
            if (!data || data.weights.length < 2) return;
            const weeks = {};
            data.labels.forEach((label, i) => {
                const parts = label.split('/');
                const d = new Date(2000 + parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                const weekStart = new Date(d);
                weekStart.setDate(d.getDate() - d.getDay() + 1);
                const key = weekStart.toISOString().split('T')[0];
                if (!weeks[key]) weeks[key] = { weights: [], start: null, end: null, label: label };
                weeks[key].weights.push(data.weights[i]);
                if (!weeks[key].start) weeks[key].start = data.weights[i];
                weeks[key].end = data.weights[i];
            });
            const rows = Object.entries(weeks).reverse().slice(0, 12).map(([key, w]) => {
                const change = w.end - w.start;
                return `<tr>
                    <td>${key}</td>
                    <td>${w.start.toFixed(1)} kg</td>
                    <td>${w.end.toFixed(1)} kg</td>
                    <td class="${change <= 0 ? 'positive' : 'negative'}">${change === 0 ? 'â€”' : (change > 0 ? '+' : '') + change.toFixed(1)}</td>
                </tr>`;
            });
            document.getElementById(`weekly-table-${p}`).innerHTML = rows.join('');
        }

        function updateMonthly(p, data) {
            if (!data || data.weights.length < 2) return;
            const months = {};
            const monthNames = ['Î™Î±Î½', 'Î¦ÎµÎ²', 'ÎœÎ±Ï', 'Î‘Ï€Ï', 'ÎœÎ±Î¹', 'Î™Î¿Ï…Î½', 'Î™Î¿Ï…Î»', 'Î‘Ï…Î³', 'Î£ÎµÏ€', 'ÎŸÎºÏ„', 'ÎÎ¿Îµ', 'Î”ÎµÎº'];
            data.labels.forEach((label, i) => {
                const parts = label.split('/');
                const key = `${monthNames[parseInt(parts[1]) - 1]} '${parts[2]}`;
                if (!months[key]) months[key] = { weights: [], start: null, end: null, count: 0 };
                months[key].weights.push(data.weights[i]);
                if (!months[key].start) months[key].start = data.weights[i];
                months[key].end = data.weights[i];
                months[key].count++;
            });
            const rows = Object.entries(months).reverse().map(([key, m]) => {
                const change = m.end - m.start;
                return `<tr>
                    <td>${key}</td>
                    <td>${m.start.toFixed(1)} kg</td>
                    <td>${m.end.toFixed(1)} kg</td>
                    <td class="${change <= 0 ? 'positive' : 'negative'}">${change === 0 ? 'â€”' : (change > 0 ? '+' : '') + change.toFixed(1)}</td>
                    <td>${m.count}</td>
                </tr>`;
            });
            document.getElementById(`monthly-table-${p}`).innerHTML = rows.join('');
        }

        function updateChart() {
            const datasets = [];
            let allLabels = [];

            if (allData.D?.labels?.length > 0) {
                allLabels = allData.D.labels;
                datasets.push({
                    label: 'D', data: allData.D.weights,
                    borderColor: '#4facfe', backgroundColor: 'rgba(79,172,254,0.1)',
                    tension: 0.3, fill: false, pointRadius: 4, borderWidth: 2
                });
                datasets.push({
                    label: 'D (7d avg)', data: allData.D.ma,
                    borderColor: 'rgba(79,172,254,0.4)', borderDash: [5,5],
                    tension: 0.4, fill: false, pointRadius: 0, borderWidth: 2
                });
            }

            if (allData.M?.labels?.length > 0) {
                if (allData.M.labels.length > allLabels.length) allLabels = allData.M.labels;
                datasets.push({
                    label: 'M', data: allData.M.weights,
                    borderColor: '#f093fb', backgroundColor: 'rgba(240,147,251,0.1)',
                    tension: 0.3, fill: false, pointRadius: 4, borderWidth: 2
                });
                datasets.push({
                    label: 'M (7d avg)', data: allData.M.ma,
                    borderColor: 'rgba(240,147,251,0.4)', borderDash: [5,5],
                    tension: 0.4, fill: false, pointRadius: 0, borderWidth: 2
                });
            }

            if (datasets.length === 0) return;

            const allWeights = [...(allData.D?.weights || []), ...(allData.M?.weights || [])];
            const minW = Math.min(...allWeights, CONFIG.D.target, CONFIG.M.target) - 5;
            const maxW = Math.max(...allWeights) + 5;

            if (chart) chart.destroy();
            chart = new Chart(document.getElementById('weightChart').getContext('2d'), {
                type: 'line',
                data: { labels: allLabels, datasets },
                options: {
                    responsive: true,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                dTarget: {
                                    type: 'line', yMin: CONFIG.D.target, yMax: CONFIG.D.target,
                                    borderColor: 'rgba(79,172,254,0.6)', borderWidth: 2, borderDash: [10,5],
                                    label: { display: true, content: 'D: ' + CONFIG.D.target + 'kg', position: 'start', backgroundColor: 'rgba(79,172,254,0.8)', font: { size: 10 } }
                                },
                                mTarget: {
                                    type: 'line', yMin: CONFIG.M.target, yMax: CONFIG.M.target,
                                    borderColor: 'rgba(240,147,251,0.6)', borderWidth: 2, borderDash: [10,5],
                                    label: { display: true, content: 'M: ' + CONFIG.M.target + 'kg', position: 'end', backgroundColor: 'rgba(240,147,251,0.8)', font: { size: 10 } }
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { min: minW, max: maxW, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }

        function updateHeatmaps() {
            ['d', 'm'].forEach(p => {
                const container = document.getElementById(`heatmap-${p}`);
                container.innerHTML = '';
                const data = p === 'd' ? allData.D : allData.M;
                if (!data) return;
                const compliance = data.dailyCompliance;
                const weeks = Math.ceil(compliance.length / 7);
                for (let w = 0; w < weeks; w++) {
                    const weekDiv = document.createElement('div');
                    weekDiv.style.cssText = 'display: flex; flex-direction: column; gap: 3px;';
                    for (let d = 0; d < 7; d++) {
                        const idx = w * 7 + d;
                        const dayDiv = document.createElement('div');
                        dayDiv.style.cssText = 'width: 14px; height: 14px; border-radius: 3px;';
                        const colors = [
                            'rgba(255,255,255,0.05)',
                            'rgba(74,222,128,0.25)',
                            'rgba(74,222,128,0.5)',
                            'rgba(74,222,128,0.75)',
                            'rgba(74,222,128,1)'
                        ];
                        dayDiv.style.background = idx < compliance.length ? colors[Math.min(4, compliance[idx])] : 'rgba(255,255,255,0.02)';
                        weekDiv.appendChild(dayDiv);
                    }
                    container.appendChild(weekDiv);
                }
            });
        }

        function updateComparison() {
            if (!allData.D || !allData.M) {
                document.getElementById('comparisonBox').style.display = 'none';
                return;
            }
            document.getElementById('comparisonBox').style.display = 'block';

            const dLost = allData.D.startKg - (allData.D.current || allData.D.startKg);
            const mLost = allData.M.startKg - (allData.M.current || allData.M.startKg);
            const dPct = Math.min(100, Math.max(0, dLost / (allData.D.startKg - CONFIG.D.target) * 100));
            const mPct = Math.min(100, Math.max(0, mLost / (allData.M.startKg - CONFIG.M.target) * 100));
            const maxLost = Math.max(dLost, mLost, 1);

            const rows = [
                { label: 'Î‘Ï€ÏÎ»ÎµÎ¹Î±', dVal: dLost.toFixed(1) + ' kg', mVal: mLost.toFixed(1) + ' kg', dW: dLost/maxLost*100, mW: mLost/maxLost*100 },
                { label: 'Î ÏÏŒÎ¿Î´Î¿Ï‚', dVal: dPct.toFixed(0) + '%', mVal: mPct.toFixed(0) + '%', dW: dPct, mW: mPct },
                { label: 'Î”Î¹Î±Ï„ÏÎ¿Ï†Î®', dVal: allData.D.compliance.diet + '%', mVal: allData.M.compliance.diet + '%', dW: allData.D.compliance.diet, mW: allData.M.compliance.diet },
                { label: 'Î†ÏƒÎºÎ·ÏƒÎ·', dVal: allData.D.compliance.gym + '%', mVal: allData.M.compliance.gym + '%', dW: allData.D.compliance.gym, mW: allData.M.compliance.gym },
                { label: '8K+', dVal: allData.D.compliance.steps + '%', mVal: allData.M.compliance.steps + '%', dW: allData.D.compliance.steps, mW: allData.M.compliance.steps },
                { label: 'NO ALC', dVal: allData.D.compliance.alcohol + '%', mVal: allData.M.compliance.alcohol + '%', dW: allData.D.compliance.alcohol, mW: allData.M.compliance.alcohol },
            ];

            document.getElementById('comparison').innerHTML = rows.map(r => `
                <div style="display: grid; grid-template-columns: 80px 1fr 50px 1fr 50px; align-items: center; gap: 10px;">
                    <div style="color: #888; font-size: 0.85em; text-align: right;">${r.label}</div>
                    <div style="height: 24px; border-radius: 12px; background: linear-gradient(90deg, #4facfe, #00f2fe); width: ${Math.max(5,r.dW)}%;"></div>
                    <div style="font-size: 0.85em; font-weight: bold; color: #4facfe; text-align: right;">${r.dVal}</div>
                    <div style="height: 24px; border-radius: 12px; background: linear-gradient(90deg, #f093fb, #f5576c); width: ${Math.max(5,r.mW)}%;"></div>
                    <div style="font-size: 0.85em; font-weight: bold; color: #f093fb;">${r.mVal}</div>
                </div>
            `).join('');
        }

        loadAllData();
        setInterval(loadAllData, 5 * 60 * 1000);
    </script>
</body>
</html>
