<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‹ï¸ Diet Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; font-size: 1.8em; }
        .subtitle { text-align: center; color: #888; margin-bottom: 30px; font-size: 0.9em; }
        
        .hidden { display: none; }
        .loading { text-align: center; padding: 40px; color: #888; }
        .error-box { background: rgba(239,68,68,0.2); border: 1px solid #ef4444; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; }
        .error-box h3 { color: #ef4444; margin-bottom: 10px; }
        .last-update { text-align: center; color: #666; font-size: 0.8em; margin-bottom: 20px; }
        
        .cards { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 700px) { .cards { grid-template-columns: 1fr; } }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card h2 { font-size: 1.4em; }
        .card.d h2 { color: #4facfe; }
        .card.m h2 { color: #f093fb; }
        
        .streak {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            background: rgba(251,146,60,0.2);
            border-radius: 20px;
            font-size: 0.9em;
        }
        .streak .fire { font-size: 1.1em; }
        .streak .count { font-weight: bold; color: #fb923c; }
        
        .stat { display: flex; justify-content: space-between; margin: 10px 0; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .stat:last-child { border-bottom: none; }
        .stat-label { color: #aaa; }
        .stat-value { font-weight: bold; font-size: 1.1em; }
        .stat-value.positive { color: #4ade80; }
        .stat-value.negative { color: #f87171; }
        .stat-value.weekly { color: #fbbf24; font-size: 0.9em; }
        
        .progress-container { margin: 20px 0; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; color: #aaa; }
        .progress-bar {
            height: 28px;
            background: rgba(255,255,255,0.1);
            border-radius: 14px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            transition: width 0.5s;
            min-width: 40px;
        }
        .progress-fill.d { background: linear-gradient(90deg, #4facfe, #00f2fe); }
        .progress-fill.m { background: linear-gradient(90deg, #f093fb, #f5576c); }
        
        .eta-box { 
            text-align: center; 
            margin-top: 15px; 
            padding: 12px; 
            background: rgba(255,255,255,0.08); 
            border-radius: 10px;
        }
        .eta-box .label { color: #888; font-size: 0.85em; }
        .eta-box .value { font-size: 1.3em; font-weight: bold; margin-top: 5px; }
        
        .compliance { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            margin-top: 15px; 
        }
        .compliance-item { 
            text-align: center; 
            padding: 12px 8px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 10px; 
        }
        .compliance-item .label { font-size: 0.75em; color: #888; margin-bottom: 5px; }
        .compliance-item .value { font-size: 1.4em; font-weight: bold; }
        
        .personal-bests {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .pb-item {
            padding: 10px;
            background: rgba(74,222,128,0.1);
            border-radius: 10px;
            text-align: center;
        }
        .pb-item .label { font-size: 0.7em; color: #888; margin-bottom: 3px; }
        .pb-item .value { font-size: 1.1em; font-weight: bold; color: #4ade80; }
        .pb-item .date { font-size: 0.65em; color: #666; margin-top: 2px; }
        
        .badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .badge {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            background: rgba(255,255,255,0.08);
        }
        .badge.gold { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .badge.silver { background: rgba(156,163,175,0.2); color: #9ca3af; }
        .badge.bronze { background: rgba(217,119,6,0.2); color: #d97706; }
        .badge.special { background: rgba(168,85,247,0.2); color: #a855f7; }
</style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‹ï¸ Diet Tracker Pro</h1>
        <p class="subtitle">D & M â€” Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚ 2026</p>
        <p class="last-update" id="lastUpdate">Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: â€”</p>
        <div class="error-box hidden" id="errorBox"><h3>âš ï¸ Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚</h3><p id="errorMsg"></p></div>
        
        <div class="cards">
            <div class="card d" id="cardD">
                <div class="card-header">
                    <h2>D</h2>
                    <div class="streak"><span class="fire">ğŸ”¥</span><span class="count" id="d-streak">0</span><span>Î·Î¼Î­ÏÎµÏ‚</span></div>
                </div>
                <div class="stat"><span class="stat-label">Î‘ÏÏ‡Î¹ÎºÏŒ</span><span class="stat-value" id="d-start">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¤ÏÎ­Ï‡Î¿Î½</span><span class="stat-value" id="d-current">â€”</span></div>
                <div class="stat"><span class="stat-label">Î•Î²Î´Î¿Î¼. Î¼.Î¿.</span><span class="stat-value weekly" id="d-weekavg">â€”</span></div>
                <div class="stat"><span class="stat-label">Î‘Ï€ÏÎ»ÎµÎ¹Î±</span><span class="stat-value positive" id="d-lost">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¥Ï€Î¿Î»ÎµÎ¯Ï€ÎµÏ„Î±Î¹</span><span class="stat-value" id="d-remaining">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¡Ï…Î¸Î¼ÏŒÏ‚/ÎµÎ²Î´</span><span class="stat-value" id="d-rate">â€”</span></div>
                <div class="progress-container">
                    <div class="progress-label"><span>Î ÏÏŒÎ¿Î´Î¿Ï‚</span><span id="d-pct">0%</span></div>
                    <div class="progress-bar"><div class="progress-fill d" id="d-bar" style="width:5%"></div></div>
                </div>
                <div class="eta-box">
                    <div class="label">ETA ÏƒÏ„ÏŒÏ‡Î¿Ï…</div>
                    <div class="value" id="d-eta">â€”</div>
                </div>
                <div class="compliance">
                    <div class="compliance-item"><div class="label">Î”Î™Î‘Î™Î¤Î‘</div><div class="value" id="d-diet">â€”</div></div>
                    <div class="compliance-item"><div class="label">Î‘Î£ÎšÎ—Î£Î—</div><div class="value" id="d-gym">â€”</div></div>
                    <div class="compliance-item"><div class="label">8K+</div><div class="value" id="d-steps">â€”</div></div>
                </div>
                <div class="personal-bests">
                    <div class="pb-item"><div class="label">ğŸ† ÎšÎ±Î»ÏÏ„ÎµÏÎ· ÎµÎ²Î´.</div><div class="value" id="d-bestweek">â€”</div><div class="date" id="d-bestweek-date"></div></div>
                    <div class="pb-item"><div class="label">ğŸ“… Max streak</div><div class="value" id="d-maxstreak">â€”</div></div>
                </div>
                <div class="badges" id="d-badges"></div>
            </div>
            
            <div class="card m" id="cardM">
                <div class="card-header">
                    <h2>M</h2>
                    <div class="streak"><span class="fire">ğŸ”¥</span><span class="count" id="m-streak">0</span><span>Î·Î¼Î­ÏÎµÏ‚</span></div>
                </div>
                <div class="stat"><span class="stat-label">Î‘ÏÏ‡Î¹ÎºÏŒ</span><span class="stat-value" id="m-start">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¤ÏÎ­Ï‡Î¿Î½</span><span class="stat-value" id="m-current">â€”</span></div>
                <div class="stat"><span class="stat-label">Î•Î²Î´Î¿Î¼. Î¼.Î¿.</span><span class="stat-value weekly" id="m-weekavg">â€”</span></div>
                <div class="stat"><span class="stat-label">Î‘Ï€ÏÎ»ÎµÎ¹Î±</span><span class="stat-value positive" id="m-lost">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¥Ï€Î¿Î»ÎµÎ¯Ï€ÎµÏ„Î±Î¹</span><span class="stat-value" id="m-remaining">â€”</span></div>
                <div class="stat"><span class="stat-label">Î¡Ï…Î¸Î¼ÏŒÏ‚/ÎµÎ²Î´</span><span class="stat-value" id="m-rate">â€”</span></div>
                <div class="progress-container">
                    <div class="progress-label"><span>Î ÏÏŒÎ¿Î´Î¿Ï‚</span><span id="m-pct">0%</span></div>
                    <div class="progress-bar"><div class="progress-fill m" id="m-bar" style="width:5%"></div></div>
                </div>
                <div class="eta-box">
                    <div class="label">ETA ÏƒÏ„ÏŒÏ‡Î¿Ï…</div>
                    <div class="value" id="m-eta">â€”</div>
                </div>
                <div class="compliance">
                    <div class="compliance-item"><div class="label">Î”Î™Î‘Î™Î¤Î‘</div><div class="value" id="m-diet">â€”</div></div>
                    <div class="compliance-item"><div class="label">Î‘Î£ÎšÎ—Î£Î—</div><div class="value" id="m-gym">â€”</div></div>
                    <div class="compliance-item"><div class="label">8K+</div><div class="value" id="m-steps">â€”</div></div>
                </div>
                <div class="personal-bests">
                    <div class="pb-item"><div class="label">ğŸ† ÎšÎ±Î»ÏÏ„ÎµÏÎ· ÎµÎ²Î´.</div><div class="value" id="m-bestweek">â€”</div><div class="date" id="m-bestweek-date"></div></div>
                    <div class="pb-item"><div class="label">ğŸ“… Max streak</div><div class="value" id="m-maxstreak">â€”</div></div>
                </div>
                <div class="badges" id="m-badges"></div>
            </div>
        </div>

        <div class="chart-container" style="background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h3 style="color: #ccc; margin: 0;">ğŸ“ˆ Trend & Moving Average</h3>
                <div class="chart-legend" style="display: flex; gap: 15px; font-size: 0.8em; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 10px; height: 10px; border-radius: 50%; background:#4facfe"></div><span>D</span></div>
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 10px; height: 10px; border-radius: 50%; background:#f093fb"></div><span>M</span></div>
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 20px; height: 2px; background:#4facfe; opacity:0.4"></div><span>7d avg</span></div>
                    <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 20px; height: 2px; background:#ef4444"></div><span>Target</span></div>
                </div>
            </div>
            <canvas id="weightChart"></canvas>
        </div>
        
        <div class="heatmap-container" style="background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #ccc; margin-bottom: 15px;">ğŸ“… Consistency Heatmap</h3>
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1; overflow-x: auto;"><h4 style="font-size: 0.9em; margin-bottom: 10px; color: #4facfe;">D</h4><div style="display: flex; gap: 3px;" id="heatmap-d"></div></div>
                <div style="flex: 1; overflow-x: auto;"><h4 style="font-size: 0.9em; margin-bottom: 10px; color: #f093fb;">M</h4><div style="display: flex; gap: 3px;" id="heatmap-m"></div></div>
            </div>
            <div style="display: flex; align-items: center; gap: 5px; margin-top: 10px; font-size: 0.7em; color: #666;">
                <span>0/3</span>
                <div style="width: 14px; height: 14px; border-radius: 3px; background: rgba(255,255,255,0.05);"></div>
                <div style="width: 14px; height: 14px; border-radius: 3px; background: rgba(74,222,128,0.3);"></div>
                <div style="width: 14px; height: 14px; border-radius: 3px; background: rgba(74,222,128,0.5);"></div>
                <div style="width: 14px; height: 14px; border-radius: 3px; background: rgba(74,222,128,0.7);"></div>
                <span>3/3</span>
            </div>
        </div>
        
        <div class="comparison-container" id="comparisonBox" style="background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
            <h3 style="color: #ccc; margin-bottom: 15px;">âš–ï¸ Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· D vs M</h3>
            <div id="comparison" style="display: flex; flex-direction: column; gap: 15px;"></div>
        </div>
    </div>
    
    <script>
        // ============================================
        // HARDCODED CONFIGURATION - EDIT HERE
        // ============================================
        const URLS = {
            D: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTP6nt9UQ58axQ8HfJrfQsJvC4HfWWFfNT9hwMMpq8sOkoFHhIcW10Cia802-JAig/pub?gid=1271072340&single=true&output=csv',
            M: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQv_roHZk_3uRLEW7V8heM98gXtuNy6juaveJgqkI-yFPHpr8icFwy8_pkTDeCoSw/pub?gid=1070987484&single=true&output=csv'
        };
        // Default config (fallback Î±Î½ Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Ï„Î¿ settings CSV)
        let CONFIG = {
            D: { start: 127.4, target: 110 },
            M: { start: 65.3, target: 58 }
        };
        
        // Optional: Settings CSV URL (Î±Î½ Î¸ÎµÏ‚ Î½Î± Î±Î»Î»Î¬Î¶ÎµÎ¹Ï‚ settings Î±Ï€ÏŒ Google Sheets)
        // Î¦Ï„Î¹Î¬Î¾Îµ sheet "Settings" Î¼Îµ: Person,Start,Target ÎºÎ±Î¹ publish Ï‰Ï‚ CSV
        // Ï€.Ï‡. D,127.4,110 / M,65.3,58
        const SETTINGS_URL = null; // Î’Î¬Î»Îµ URL Î±Î½ Î¸ÎµÏ‚ dynamic settings
        // ============================================
        
        let chart = null;
        let allData = { D: null, M: null };
        
        async function loadAllData() {
            document.getElementById('lastUpdate').textContent = 'Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...';
            let errors = [];
            
            // Load settings from CSV if URL provided
            if (SETTINGS_URL) {
                try {
                    const resp = await fetch(SETTINGS_URL);
                    if (resp.ok) {
                        const csv = await resp.text();
                        const rows = csv.split('\n').slice(1); // skip header
                        rows.forEach(row => {
                            const [person, start, target] = row.split(',').map(c => c.trim());
                            if (person === 'D' || person === 'M') {
                                CONFIG[person] = { start: parseFloat(start), target: parseFloat(target) };
                            }
                        });
                        console.log('Settings loaded:', CONFIG);
                    }
                } catch(e) { console.warn('Settings CSV not loaded, using defaults'); }
            }
            
            // Load D
            try {
                const resp = await fetch(URLS.D);
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const csv = await resp.text();
                allData.D = parseCSV(csv, CONFIG.D);
                updateCard('d', allData.D, CONFIG.D);
            } catch(e) { 
                console.error('D error:', e); 
                errors.push('D: ' + e.message);
            }
            
            // Load M
            try {
                const resp = await fetch(URLS.M);
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const csv = await resp.text();
                allData.M = parseCSV(csv, CONFIG.M);
                updateCard('m', allData.M, CONFIG.M);
            } catch(e) { 
                console.error('M error:', e); 
                errors.push('M: ' + e.message);
            }
            
            if (errors.length > 0) {
                document.getElementById('errorBox').classList.remove('hidden');
                document.getElementById('errorMsg').textContent = errors.join(' | ');
            }
            
            updateChart();
            updateHeatmaps();
            updateComparison();
            
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 'Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·: ' + now.toLocaleString('el-GR');
        }
        
        function parseCSV(csv, cfg) {
            const rows = csv.split('\n').map(r => r.split(',').map(c => c.trim()));
            const data = rows.slice(1).filter(r => r[0] && r[0].length > 0);
            
            const cols = { date: 0, day: 1, weight: 2, diet: 3, gym: 4, steps: 5 };
            
            const weights = [];
            const labels = [];
            const dailyCompliance = [];
            let startKg = cfg.start;
            
            data.forEach((row) => {
                const w = parseFloat(row[cols.weight]);
                if (w > 0) {
                    if (weights.length === 0) startKg = w;
                    labels.push(row[0]);
                    weights.push(w);
                }
                
                let score = 0;
                if (row[cols.diet] === 'TRUE') score++;
                if (row[cols.gym] === 'TRUE') score++;
                if (row[cols.steps] === 'TRUE') score++;
                dailyCompliance.push(score);
            });
            
            const calcCompliance = (col) => {
                const filled = data.filter(r => r[col] === 'TRUE' || r[col] === 'FALSE');
                const yes = filled.filter(r => r[col] === 'TRUE').length;
                return filled.length > 0 ? Math.round(yes / filled.length * 100) : 0;
            };
            
            let streak = 0;
            for (let i = dailyCompliance.length - 1; i >= 0; i--) {
                if (dailyCompliance[i] >= 2) streak++;
                else break;
            }
            
            let maxStreak = 0, tempStreak = 0;
            dailyCompliance.forEach(s => {
                if (s >= 2) { tempStreak++; maxStreak = Math.max(maxStreak, tempStreak); }
                else tempStreak = 0;
            });
            
            let bestWeek = { loss: 0, date: '' };
            for (let i = 1; i < weights.length; i++) {
                const loss = weights[i-1] - weights[i];
                if (loss > bestWeek.loss) bestWeek = { loss, date: labels[i] };
            }
            
            const ma = [];
            for (let i = 0; i < weights.length; i++) {
                const start = Math.max(0, i - 6);
                const slice = weights.slice(start, i + 1);
                ma.push(slice.reduce((a,b) => a+b, 0) / slice.length);
            }
            
            const last7 = weights.slice(-7);
            const weekAvg = last7.length > 0 ? last7.reduce((a,b) => a+b, 0) / last7.length : null;
            
            return {
                weights, labels, ma, dailyCompliance, startKg,
                current: weights.length > 0 ? weights[weights.length - 1] : null,
                weekAvg, streak, maxStreak, bestWeek,
                compliance: {
                    diet: calcCompliance(cols.diet),
                    gym: calcCompliance(cols.gym),
                    steps: calcCompliance(cols.steps)
                }
            };
        }

        function updateCard(p, data, cfg) {
            if (!data || !data.startKg) return;
            
            const start = data.startKg;
            const current = data.current || start;
            const target = cfg.target;
            const lost = start - current;
            const remaining = current - target;
            const weightCount = data.weights.length;
            const weeks = Math.max(1, weightCount - 1);
            const rate = lost / weeks;
            const pct = Math.min(100, Math.max(0, lost / (start - target) * 100));
            const etaWeeks = rate > 0 ? Math.ceil(remaining / rate) : null;
            
            document.getElementById(`${p}-start`).textContent = start.toFixed(1) + ' kg';
            document.getElementById(`${p}-current`).textContent = current.toFixed(1) + ' kg';
            document.getElementById(`${p}-weekavg`).textContent = data.weekAvg ? data.weekAvg.toFixed(1) + ' kg' : 'â€”';
            
            const lostEl = document.getElementById(`${p}-lost`);
            lostEl.textContent = (lost >= 0 ? '-' : '+') + Math.abs(lost).toFixed(1) + ' kg';
            lostEl.className = 'stat-value ' + (lost >= 0 ? 'positive' : 'negative');
            
            document.getElementById(`${p}-remaining`).textContent = remaining.toFixed(1) + ' kg';
            document.getElementById(`${p}-rate`).textContent = rate.toFixed(2) + ' kg';
            document.getElementById(`${p}-pct`).textContent = pct.toFixed(0) + '%';
            document.getElementById(`${p}-bar`).style.width = Math.max(5, pct) + '%';
            document.getElementById(`${p}-bar`).textContent = pct.toFixed(0) + '%';
            document.getElementById(`${p}-eta`).textContent = etaWeeks ? `~${etaWeeks} ÎµÎ²Î´.` : 'â€”';
            document.getElementById(`${p}-streak`).textContent = data.streak;
            document.getElementById(`${p}-diet`).textContent = data.compliance.diet + '%';
            document.getElementById(`${p}-gym`).textContent = data.compliance.gym + '%';
            document.getElementById(`${p}-steps`).textContent = data.compliance.steps + '%';
            document.getElementById(`${p}-bestweek`).textContent = data.bestWeek.loss > 0 ? '-' + data.bestWeek.loss.toFixed(1) + ' kg' : 'â€”';
            document.getElementById(`${p}-bestweek-date`).textContent = data.bestWeek.date;
            document.getElementById(`${p}-maxstreak`).textContent = data.maxStreak + ' Î·Î¼Î­ÏÎµÏ‚';
            
            const badges = [];
            if (lost >= 1) badges.push({ text: 'ğŸ¯ First kg', class: 'bronze' });
            if (lost >= 5) badges.push({ text: 'ğŸ¥‡ 5kg Club', class: 'gold' });
            if (lost >= 10) badges.push({ text: 'ğŸ† 10kg Club', class: 'gold' });
            if (data.maxStreak >= 7) badges.push({ text: 'ğŸ”¥ 7-day streak', class: 'bronze' });
            if (data.maxStreak >= 14) badges.push({ text: 'âš¡ 14-day streak', class: 'special' });
            if (data.compliance.diet >= 90) badges.push({ text: 'ğŸ’ª Diet Master', class: 'special' });
            if (weightCount >= 7) badges.push({ text: 'ğŸ“… Week 1', class: 'silver' });
            if (weightCount >= 30) badges.push({ text: 'ğŸ“… Month 1', class: 'silver' });
            
            document.getElementById(`${p}-badges`).innerHTML = badges.map(b => `<span class="badge ${b.class}">${b.text}</span>`).join('');
        }
        
        function updateChart() {
            const datasets = [];
            let allLabels = [];
            
            if (allData.D && allData.D.labels.length > 0) {
                allLabels = allData.D.labels;
                datasets.push({
                    label: 'D', data: allData.D.weights,
                    borderColor: '#4facfe', backgroundColor: 'rgba(79,172,254,0.1)',
                    tension: 0.3, fill: false, pointRadius: 4, borderWidth: 2
                });
                datasets.push({
                    label: 'D (7d avg)', data: allData.D.ma,
                    borderColor: 'rgba(79,172,254,0.4)', borderDash: [5,5],
                    tension: 0.4, fill: false, pointRadius: 0, borderWidth: 2
                });
            }
            
            if (allData.M && allData.M.labels.length > 0) {
                if (allData.M.labels.length > allLabels.length) allLabels = allData.M.labels;
                datasets.push({
                    label: 'M', data: allData.M.weights,
                    borderColor: '#f093fb', backgroundColor: 'rgba(240,147,251,0.1)',
                    tension: 0.3, fill: false, pointRadius: 4, borderWidth: 2
                });
                datasets.push({
                    label: 'M (7d avg)', data: allData.M.ma,
                    borderColor: 'rgba(240,147,251,0.4)', borderDash: [5,5],
                    tension: 0.4, fill: false, pointRadius: 0, borderWidth: 2
                });
            }
            
            if (datasets.length === 0) return;
            
            let allWeights = [...(allData.D?.weights || []), ...(allData.M?.weights || [])];
            const minW = Math.min(...allWeights, CONFIG.D.target, CONFIG.M.target) - 5;
            const maxW = Math.max(...allWeights) + 5;
            
            if (chart) chart.destroy();
            const ctx = document.getElementById('weightChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: allLabels, datasets },
                options: {
                    responsive: true,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { 
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                dTarget: {
                                    type: 'line', yMin: CONFIG.D.target, yMax: CONFIG.D.target,
                                    borderColor: 'rgba(79,172,254,0.6)', borderWidth: 2, borderDash: [10,5],
                                    label: { display: true, content: 'D: ' + CONFIG.D.target + 'kg', position: 'start', backgroundColor: 'rgba(79,172,254,0.8)', font: { size: 10 } }
                                },
                                mTarget: {
                                    type: 'line', yMin: CONFIG.M.target, yMax: CONFIG.M.target,
                                    borderColor: 'rgba(240,147,251,0.6)', borderWidth: 2, borderDash: [10,5],
                                    label: { display: true, content: 'M: ' + CONFIG.M.target + 'kg', position: 'end', backgroundColor: 'rgba(240,147,251,0.8)', font: { size: 10 } }
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { min: minW, max: maxW, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }
        
        function updateHeatmaps() {
            ['d', 'm'].forEach(p => {
                const container = document.getElementById(`heatmap-${p}`);
                container.innerHTML = '';
                const data = p === 'd' ? allData.D : allData.M;
                if (!data) return;
                
                const compliance = data.dailyCompliance;
                const weeks = Math.ceil(compliance.length / 7);
                
                for (let w = 0; w < weeks; w++) {
                    const weekDiv = document.createElement('div');
                    weekDiv.style.cssText = 'display: flex; flex-direction: column; gap: 3px;';
                    for (let d = 0; d < 7; d++) {
                        const idx = w * 7 + d;
                        const dayDiv = document.createElement('div');
                        dayDiv.style.cssText = 'width: 14px; height: 14px; border-radius: 3px;';
                        if (idx < compliance.length) {
                            const level = Math.min(3, compliance[idx]);
                            const colors = ['rgba(255,255,255,0.05)', 'rgba(74,222,128,0.3)', 'rgba(74,222,128,0.5)', 'rgba(74,222,128,0.7)'];
                            dayDiv.style.background = colors[level];
                        } else {
                            dayDiv.style.background = 'rgba(255,255,255,0.02)';
                        }
                        weekDiv.appendChild(dayDiv);
                    }
                    container.appendChild(weekDiv);
                }
            });
        }
        
        function updateComparison() {
            if (!allData.D || !allData.M) {
                document.getElementById('comparisonBox').style.display = 'none';
                return;
            }
            document.getElementById('comparisonBox').style.display = 'block';
            
            const dLost = allData.D.startKg - (allData.D.current || allData.D.startKg);
            const mLost = allData.M.startKg - (allData.M.current || allData.M.startKg);
            const dPct = Math.min(100, Math.max(0, dLost / (allData.D.startKg - CONFIG.D.target) * 100));
            const mPct = Math.min(100, Math.max(0, mLost / (allData.M.startKg - CONFIG.M.target) * 100));
            
            const maxLost = Math.max(dLost, mLost, 1);
            
            const rows = [
                { label: 'Î‘Ï€ÏÎ»ÎµÎ¹Î±', dVal: dLost.toFixed(1) + ' kg', mVal: mLost.toFixed(1) + ' kg', dW: dLost/maxLost*100, mW: mLost/maxLost*100 },
                { label: 'Î ÏÏŒÎ¿Î´Î¿Ï‚', dVal: dPct.toFixed(0) + '%', mVal: mPct.toFixed(0) + '%', dW: dPct, mW: mPct },
                { label: 'Î”Î¹Î±Ï„ÏÎ¿Ï†Î®', dVal: allData.D.compliance.diet + '%', mVal: allData.M.compliance.diet + '%', dW: allData.D.compliance.diet, mW: allData.M.compliance.diet },
                { label: 'Î†ÏƒÎºÎ·ÏƒÎ·', dVal: allData.D.compliance.gym + '%', mVal: allData.M.compliance.gym + '%', dW: allData.D.compliance.gym, mW: allData.M.compliance.gym },
                { label: '8K+', dVal: allData.D.compliance.steps + '%', mVal: allData.M.compliance.steps + '%', dW: allData.D.compliance.steps, mW: allData.M.compliance.steps },
            ];
            
            document.getElementById('comparison').innerHTML = rows.map(r => `
                <div style="display: grid; grid-template-columns: 80px 1fr 50px 1fr 50px; align-items: center; gap: 10px;">
                    <div style="color: #888; font-size: 0.85em; text-align: right;">${r.label}</div>
                    <div style="height: 24px; border-radius: 12px; background: linear-gradient(90deg, #4facfe, #00f2fe); width: ${Math.max(5,r.dW)}%;"></div>
                    <div style="font-size: 0.85em; font-weight: bold; color: #4facfe; text-align: right;">${r.dVal}</div>
                    <div style="height: 24px; border-radius: 12px; background: linear-gradient(90deg, #f093fb, #f5576c); width: ${Math.max(5,r.mW)}%;"></div>
                    <div style="font-size: 0.85em; font-weight: bold; color: #f093fb;">${r.mVal}</div>
                </div>
            `).join('');
        }
        
        // Auto-load on page load
        loadAllData();
        
        // Auto-refresh every 5 minutes
        setInterval(loadAllData, 5 * 60 * 1000);
    </script>
</body>
</html>
